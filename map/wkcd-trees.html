<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WKCD Tree Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 8px;
            z-index: 1001;
            font-size: 16px;
            color: #333;
        }

        /* Top Left Controls */
        .top-left-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-group {
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
        }

        .zoom-controls {
            display: flex;
            flex-direction: column;
        }

        .zoom-controls button {
            width: 34px;
            height: 34px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: background 0.2s;
        }

        .zoom-controls button:hover {
            background: #f4f4f4;
        }

        .zoom-controls button:first-child {
            border-bottom: 1px solid #ccc;
            border-radius: 4px 4px 0 0;
        }

        .zoom-controls button:last-child {
            border-radius: 0 0 4px 4px;
        }

        .layer-selector {
            padding: 10px;
            min-width: 150px;
        }

        .layer-selector h4 {
            margin-bottom: 8px;
            font-size: 14px;
            color: #333;
        }

        .layer-selector label {
            display: block;
            padding: 4px 0;
            cursor: pointer;
            font-size: 13px;
        }

        .layer-selector input[type="radio"] {
            margin-right: 6px;
        }

        .collapsed {
            display: none;
        }

        .toggle-btn {
            width: 34px;
            height: 34px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 16px;
            border-radius: 4px;
        }

        .toggle-btn:hover {
            background: #f4f4f4;
        }

        /* Bottom Left Panel */
        .main-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 350px;
            max-height: 70vh;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 12px 15px;
            background: #2c5f2d;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .panel-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .panel-content {
            overflow-y: auto;
            max-height: calc(70vh - 48px);
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f8f8;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 13px;
            transition: background 0.2s;
        }

        .tab:hover {
            background: #e8e8e8;
        }

        .tab.active {
            background: white;
            border-bottom: 2px solid #2c5f2d;
            font-weight: 600;
        }

        .tab-content {
            padding: 15px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-box {
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .filter-section {
            margin-bottom: 15px;
        }

        .filter-section h4 {
            font-size: 13px;
            margin-bottom: 8px;
            color: #555;
        }

        .filter-option {
            display: flex;
            align-items: center;
            padding: 6px 0;
        }

        .filter-option input[type="checkbox"] {
            margin-right: 8px;
        }

        .filter-option label {
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .species-color {
            width: 16px;
            height: 16px;
            display: inline-block;
            border: 2px solid white;
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }

        .species-color.circle {
            border-radius: 50%;
        }

        .species-color.square {
            transform: rotate(45deg);
        }

        .species-color.triangle {
            width: 0;
            height: 0;
            border: none;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 14px solid;
            box-shadow: none;
            position: relative;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-card {
            background: #f8f8f8;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c5f2d;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .tree-detail {
            padding: 15px;
        }

        .tree-detail h4 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #2c5f2d;
        }

        .detail-row {
            margin-bottom: 10px;
            font-size: 13px;
        }

        .detail-label {
            font-weight: 600;
            color: #555;
        }

        .detail-value {
            color: #333;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.8;
        }

        .btn-primary {
            background: #2c5f2d;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        /* Bottom Right Legend - Now integrated into weather widget */
        .legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 250px;
        }

        /* Hide standalone legend on mobile, show integrated version */
        @media (max-width: 768px) {
            .legend {
                display: none;
            }
        }

        .legend h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .legend-item .species-color {
            margin-right: 8px;
        }

        #legendContent {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 5px;
        }

        #legendContent::-webkit-scrollbar {
            width: 6px;
        }

        #legendContent::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #legendContent::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        #legendContent::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .weather-legend-content::-webkit-scrollbar {
            width: 6px;
        }

        .weather-legend-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .weather-legend-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .weather-legend-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .legend-name-toggle {
            margin-top: 8px;
            margin-bottom: 8px;
            font-size: 11px;
        }

        .legend-name-toggle select {
            width: 100%;
            padding: 4px;
            font-size: 11px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading">Loading trees...</div>

    <!-- Top Left Controls -->
    <div class="top-left-controls">
        <div class="control-group zoom-controls">
            <button onclick="map.zoomIn()">+</button>
            <button onclick="map.zoomOut()">-</button>
        </div>

        <button class="toggle-btn" onclick="toggleLayerSelector()"><i class="fas fa-layer-group"></i></button>
        <div class="control-group layer-selector collapsed" id="layerSelector">
            <h4>Base Map</h4>
            <label><input type="radio" name="baseMap" value="streets" checked onclick="changeBaseMap('streets')">Streets</label>
            <label><input type="radio" name="baseMap" value="satellite" onclick="changeBaseMap('satellite')">Satellite</label>
            <label><input type="radio" name="baseMap" value="terrain" onclick="changeBaseMap('terrain')">Terrain</label>
        </div>
    </div>

    <!-- Bottom Left Main Panel -->
    <div class="main-panel">
        <div class="panel-header" onclick="togglePanel()">
            <h3>Tree Explorer</h3>
            <i id="panelToggleIcon" class="fas fa-chevron-down"></i>
        </div>
        <div id="panelContent" class="panel-content">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('search')">Search</button>
                <button class="tab" onclick="switchTab('filters')">Filters</button>
                <button class="tab" onclick="switchTab('stats')">Stats</button>
                <button class="tab" onclick="switchTab('tools')">Tools</button>
            </div>

            <div id="searchTab" class="tab-content active">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search by name or ID..." oninput="searchTrees()">
                </div>
                <div id="searchResults"></div>
            </div>

            <div id="filtersTab" class="tab-content">
                <div class="filter-section">
                    <h4>Species</h4>
                    <div id="speciesFilters"></div>
                </div>
            </div>

            <div id="statsTab" class="tab-content">
                <div class="stats-grid" id="statsGrid"></div>
            </div>

            <div id="toolsTab" class="tab-content">
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="zoomToExtent()"><i class="fas fa-expand"></i> Fit all trees</button>
                    <button class="btn btn-secondary" onclick="geolocate()"><i class="fas fa-location-arrow"></i> My location</button>
                </div>
                <div class="action-buttons" style="margin-top: 10px;">
                    <button class="btn btn-primary" onclick="exportData('csv')"><i class="fas fa-download"></i> Export CSV</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Right Legend -->
    <div class="legend">
        <h4>Species Legend <i class="fas fa-chevron-down" onclick="toggleLegend()"></i></h4>
        <div id="legendContent"></div>
        <div class="legend-name-toggle">
            <select id="legendNameType" onchange="updateSpeciesLegend()">
                <option value="short">Short Scientific Name</option>
                <option value="chinese">Chinese Name</option>
            </select>
        </div>
    </div>

    <!-- Weather Widget (Integrated Legend on Mobile) -->
    <div id="weatherWidget" style="position: absolute; bottom: 10px; right: 10px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 1000; display: none;">
        <div id="weatherInfo"></div>
        <h4>Species Legend <i id="weatherLegendToggleIcon" class="fas fa-chevron-down" onclick="toggleWeatherLegend()"></i></h4>
        <div id="weatherLegendContent" class="weather-legend-content"></div>
        <div class="legend-name-toggle">
            <select id="weatherLegendNameType" onchange="updateWeatherLegendNames()">
                <option value="short">Short Scientific Name</option>
                <option value="chinese">Chinese Name</option>
            </select>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script>
        let map, treeMarkers, clusterGroup, treesData = [];
        let speciesColors = {}, speciesShapes = ['circle', 'square', 'triangle'];
        let currentBaseMap = 'streets';
        let labelsEnabled = false;
        let labelType = 'short';
        let legendNameType = 'short';
        let baseMaps = {
            streets: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 25 }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 25 }),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 25 })
        };
        const CHUNK_SIZE = 10000;  // Process 10k trees per chunk to avoid UI freeze

        // Initialize map
        function initMap() {
            map = L.map('map', {
                center: [22.2998, 114.1570],
                zoom: 18,
                maxZoom: 25,
                minZoom: 10,
                zoomControl: false
            });
            baseMaps.streets.addTo(map);

            treeMarkers = L.layerGroup();
            clusterGroup = L.markerClusterGroup({
                disableClusteringAtZoom: 22,  // Stop clustering at zoom level 22 for more precise view
                zoomToBoundsOnClick: true,   // Zoom to bounds when clicking a cluster
                maxClusterRadius: 80
            });

            drawnItems = L.featureGroup().addTo(map);
            new L.Control.Draw({
                draw: { marker: false, circle: false, rectangle: false, circlemarker: false },
                edit: { featureGroup: drawnItems }
            }).addTo(map);

            map.on('draw:created', e => {
                drawnItems.addLayer(e.layer);
                if (e.layerType === 'polyline') {
                    const distance = e.layer.getLatLngs().reduce((dist, latlng, i, arr) => 
                        i > 0 ? dist + arr[i-1].distanceTo(latlng) : dist, 0);
                    alert(`Distance: ${distance.toFixed(2)} meters`);
                } else if (e.layerType === 'polygon') {
                    const area = L.GeometryUtil.geodesicArea(e.layer.getLatLngs()[0]);
                    alert(`Area: ${area.toFixed(2)} sq meters`);
                }
            });

            loadData();
            loadWeather();
        }

        async function loadData() {
            document.getElementById('loading').style.display = 'block';
            try {
                const response = await fetch('treei.csv');
                const csvText = await response.text();
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        treesData = results.data.filter(tree => {
                            const lng = parseFloat(tree.x);
                            const lat = parseFloat(tree.y);
                            return !isNaN(lng) && !isNaN(lat);
                        }).map(tree => ({
                            ...tree,
                            lat: parseFloat(tree.y),
                            lng: parseFloat(tree.x)
                        }));
                        processSpecies();
                        addMarkersChunked(0);  // Start chunked marker addition
                    }
                });
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
            }
        }

        function addMarkersChunked(index) {
            const end = Math.min(index + CHUNK_SIZE, treesData.length);
            for (let i = index; i < end; i++) {
                const tree = treesData[i];
                const sp = tree.botanical_name;
                const icon = L.divIcon({
                    className: 'tree-marker',
                    html: `<div class="species-color ${speciesShapes[sp] || 'circle'}" style="background: ${speciesColors[sp] || '#ff0000'};"></div>`,
                    iconSize: [16, 16]
                });

                const marker = L.marker([tree.lat, tree.lng], { icon });
                marker.treeData = tree;
                marker.on('click', showTreeDetails);
                clusterGroup.addLayer(marker);
            }

            if (end < treesData.length) {
                requestAnimationFrame(() => addMarkersChunked(end));  // Next chunk
            } else {
                map.addLayer(clusterGroup);
                updateStats();
                updateSpeciesFilter();
                updateSpeciesLegend();
                zoomToExtent();
                document.getElementById('loading').style.display = 'none';
            }
        }

        function processSpecies() {
            const species = [...new Set(treesData.map(t => t.botanical_name))];
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
            species.forEach((sp, i) => {
                speciesColors[sp] = colors[i % colors.length];
                speciesShapes[sp] = speciesShapes[i % speciesShapes.length];
            });
        }

        function showTreeDetails(e) {
            const tree = e.target.treeData;
            let html = `
                <h4>${tree.botanical_name}</h4>
                <div class="detail-row"><span class="detail-label">Chinese Name:</span> <span class="detail-value">${tree.chinese_name}</span></div>
                <div class="detail-row"><span class="detail-label">ID:</span> <span class="detail-value">${tree.fid}</span></div>
                <div class="detail-row"><span class="detail-label">Remarks:</span> <span class="detail-value">${tree.remarks || 'None'}</span></div>
                <div class="detail-row"><span class="detail-label">DBH:</span> <span class="detail-value">${tree.DBH || 'N/A'}</span></div>
                <div class="detail-row"><span class="detail-label">Crown Spread:</span> <span class="detail-value">${tree['Crown Spread'] || 'N/A'}</span></div>
                <div class="detail-row"><span class="detail-label">Tree Height:</span> <span class="detail-value">${tree['Tree Height'] || 'N/A'}</span></div>
            `;
            L.popup().setLatLng(e.latlng).setContent(html).openOn(map);
        }

        function updateStats() {
            if (treesData.length === 0) {
                console.warn("No tree data loaded");
                return;
            }

            const speciesCount = {};
            treesData.forEach(t => {
                speciesCount[t.botanical_name] = (speciesCount[t.botanical_name] || 0) + 1;
            });

            let html = `
                <div class="stat-card">
                    <div class="stat-value">${treesData.length}</div>
                    <div class="stat-label">Total Trees</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Object.keys(speciesCount).length}</div>
                    <div class="stat-label">Species</div>
                </div>
            `;
            document.getElementById('statsGrid').innerHTML = html;
        }

        function updateSpeciesFilter() {
            let html = '';
            Object.keys(speciesColors).forEach(sp => {
                const id = `species_${sp.replace(/[^a-zA-Z0-9]/g, '_')}`;
                html += `
                    <div class="filter-option">
                        <input type="checkbox" id="${id}" checked onchange="updateMarkers()">
                        <label for="${id}">
                            <span class="species-color ${speciesShapes[sp]}" style="background: ${speciesColors[sp]};"></span>
                            ${sp}
                        </label>
                    </div>
                `;
            });
            document.getElementById('speciesFilters').innerHTML = html;
        }

        function updateSpeciesLegend() {
            let html = '';
            Object.keys(speciesColors).forEach(sp => {
                const name = legendNameType === 'short' ? getShortScientificName(sp) : treesData.find(t => t.botanical_name === sp).chinese_name;
                html += `
                    <div class="legend-item">
                        <span class="species-color ${speciesShapes[sp]}" style="background: ${speciesColors[sp]};"></span>
                        ${name}
                    </div>
                `;
            });
            document.getElementById('legendContent').innerHTML = html;
        }

        function getShortScientificName(name) {
            const parts = name.split(' ');
            return parts.length > 1 ? `${parts[0][0]}. ${parts[1]}` : name;
        }

        function updateMarkers() {
            clusterGroup.clearLayers();
            const selectedSpecies = Object.keys(speciesColors).filter(sp => {
                const id = `species_${sp.replace(/[^a-zA-Z0-9]/g, '_')}`;
                return document.getElementById(id).checked;
            });

            treesData.filter(t => selectedSpecies.includes(t.botanical_name)).forEach(tree => {
                const sp = tree.botanical_name;
                const icon = L.divIcon({
                    className: 'tree-marker',
                    html: `<div class="species-color ${speciesShapes[sp]}" style="background: ${speciesColors[sp]};"></div>`,
                    iconSize: [16, 16]
                });
                const marker = L.marker([tree.lat, tree.lng], { icon });
                marker.treeData = tree;
                marker.on('click', showTreeDetails);
                clusterGroup.addLayer(marker);
            });
        }

        function searchTrees() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            let results = '';
            treesData.filter(t => t.botanical_name.toLowerCase().includes(query) || t.fid.toString().includes(query)).forEach(tree => {
                results += `<div onclick="map.setView([${tree.lat}, ${tree.lng}], 18)">${tree.botanical_name} (ID: ${tree.fid})</div>`;
            });
            document.getElementById('searchResults').innerHTML = results || 'No results';
        }

        function toggleClustering() {
            if (document.getElementById('clustering').checked) {
                map.removeLayer(treeMarkers);
                map.addLayer(clusterGroup);
            } else {
                map.removeLayer(clusterGroup);
                map.addLayer(treeMarkers);
            }
        }

        function toggleLabels() {
            labelsEnabled = document.getElementById('showLabels').checked;
            updateLabels();
        }

        function updateLabels() {
            labelType = document.getElementById('labelType').value;
            
            clusterGroup.eachLayer(marker => {
                if (labelsEnabled && marker.treeData) {  // Check for treeData to avoid clusters
                    const tree = marker.treeData;
                    let label = labelType === 'short' 
                        ? getShortScientificName(tree.botanical_name)
                        : tree.chinese_name;
                    
                    marker.bindTooltip(label, { 
                        permanent: true, 
                        direction: 'top',
                        className: 'tree-label',
                        offset: [0, -10]
                    });
                } else {
                    marker.unbindTooltip();
                }
            });
        }

        function togglePanel() {
            const content = document.getElementById('panelContent');
            const icon = document.getElementById('panelToggleIcon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-down';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-up';
            }
        }

        function toggleLegend() {
            const content = document.getElementById('legendContent');
            if (content.style.display === 'none') {
                content.style.display = 'block';
            } else {
                content.style.display = 'none';
            }
        }

        function updateWeatherLegendNames() {
            legendNameType = document.getElementById('weatherLegendNameType').value;
            const desktopSelector = document.getElementById('legendNameType');
            if (desktopSelector) {
                desktopSelector.value = legendNameType;
            }
            updateSpeciesLegend();
        }

        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab:nth-child(${
                tabName === 'search' ? 1 : tabName === 'filters' ? 2 : tabName === 'stats' ? 3 : 4
            })`).classList.add('active');
            
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function changeBaseMap(type) {
            Object.values(baseMaps).forEach(layer => map.removeLayer(layer));
            baseMaps[type].addTo(map);
            currentBaseMap = type;
        }

        function zoomToExtent() {
            if (treesData.length === 0) return;
            const bounds = L.latLngBounds(treesData.map(t => [t.lat, t.lng]));
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        function geolocate() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    map.setView([position.coords.latitude, position.coords.longitude], 18);
                    L.marker([position.coords.latitude, position.coords.longitude], {
                        icon: L.divIcon({
                            className: 'user-location',
                            html: '<i class="fas fa-circle" style="color: #4a90e2; font-size: 12px;"></i>',
                            iconSize: [12, 12]
                        })
                    }).addTo(map).bindPopup('Your location');
                }, error => {
                    alert('Unable to get your location');
                });
            } else {
                alert('Geolocation not supported');
            }
        }

        function exportData(format) {
            const speciesChecked = Object.keys(speciesColors).filter(sp => {
                const id = `species_${sp.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const checkbox = document.getElementById(id);
                return checkbox && checkbox.checked;
            });
            
            const filteredTrees = treesData.filter(t => speciesChecked.includes(t.botanical_name));

            if (format === 'csv') {
                let csv = 'botanical_name,chinese_name,fid,remarks,x,y\n';
                filteredTrees.forEach(t => {
                    csv += `${t.botanical_name},"${t.chinese_name}",${t.fid},"${t.remarks || ''}",${t.lng},${t.lat}\n`;
                });
                
                downloadFile(csv, 'trees.csv', 'text/csv');
            }
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadWeather() {
            // Mock weather data
            document.getElementById('weatherInfo').innerHTML = '24Â°C, Partly Cloudy';
        }

        window.addEventListener('load', initMap);
    </script>
</body>
</html>